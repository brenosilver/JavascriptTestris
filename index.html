<!DOCTYPE html>
<html>
	<head>
		<title>Script Testris</title>
		
		<script src="jquery-1.11.1.min.js"></script>
		<link rel="stylesheet" href="style.css" />
		
		<script type="text/javascript">
		
		/*
		|----| 1 2 3 4
		|----| 5 6 7 8
		|----| 9 10 11 12
		|----| 13 14 15 16
		*/
			var rows;
			var columns;
			var windowH;
			var windowW;
			var cubes = new Array();
			var cubeTimeOffset = 0;
			
			var timeout = 1000;
						
			function straightPiece(){
				this.id = 1;
				this.positionY = [0,1,2,3]; // rows
				this.positionX = [0,0,0,0]; // columns
				this.color = 'blue';
				this.isActive = false;
			}
									
			function squarePiece(){
				this.id = 2;
				this.positionY = [0,1,0,1]; // rows
				this.positionX = [0,0,1,1]; // columns
				this.color = 'blue';
				this.isActive = false;
			}
					
			function cornerLeftPiece(){
				this.id = 3;
				this.positionY = [0,1,1,1]; // rows
				this.positionX = [0,0,1,2]; // columns
				this.color = 'blue';
				this.isActive = false;
			}
						
			function cornerRightPiece(){
				this.id = 4;
				this.positionY = [1,1,1,0]; // rows
				this.positionX = [0,1,2,2]; // columns
				this.color = 'blue';
				this.isActive = false;
			}
			
			function wPiece(){
				this.id = 5;
				this.positionY = [1,1,0,1]; // rows
				this.positionX = [0,1,1,2]; // columns
				this.color = 'blue';
				this.isActive = false;
			}
						
			function zLeftPiece(){
				this.id = 6;
				this.positionY = [0,0,1,1]; // rows
				this.positionX = [0,1,1,2]; // columns
				this.color = 'blue';
				this.isActive = false;
			}
					
			function zRightPiece(){
				this.id = 7;
				this.positionY = [1,0,1,0]; // rows
				this.positionX = [0,1,1,2]; // columns
				this.color = 'blue';
				this.isActive = false;
			}
			
			function cube(size, row, column){
				this.row = row;
				this.column = column;
				this.element = document.createElement('div');
				this.element.className = "cube";
				this.element.style.height = size + 'px';
				this.element.style.width = size + 'px';
				this.element.style.display = "inline-block";
				this.element.setAttribute("data-row", this.row);
				this.element.setAttribute("data-column", this.column);
			}
			
			
			// Clock function
			function clickTime(piece){
				if(piece != null) this.piece = piece;
				
				cubeTimeOffset++;
				if(cubeTimeOffset > rows) cubeTimeOffset = 0;
				
				console.log("piece : "+this.piece);
				movePiece(this.piece, cubeTimeOffset);
				
				setTimeout(clickTime, timeout);
			}
			
			// Randomly generates a new piece
			function newPiece(){
				var rand = Math.floor((Math.random()* 7) + 1);
				
				switch(rand){
					case 1: return (new straightPiece());
					case 2: return (new squarePiece());
					case 3: return (new cornerLeftPiece());
					case 4: return (new cornerRightPiece());
					case 5: return (new wPiece());
					case 6: return (new zLeftPiece()); 
					case 7: return (new zRightPiece()); 
				}
			}
			
			// Place the piece in the grid
			function placePiece(obj){
				for(var i = 0; i < obj.positionY.length; i++){
					cubes[obj.positionY[i]][obj.positionX[i]].element.style.backgroundColor = obj.color;
				}
			}
			
			// Move pieces down the cubes each time click
			function movePiece(obj, timeOffset){
			
				for(var i = 0; i < obj.positionY.length; i++){
					cubes[obj.positionY[i]+timeOffset][obj.positionX[i]].element.style.backgroundColor = obj.color;
				}
				
				/*for(var i = 0; i < obj.positionY.length; i++){
					if(obj.positionY[i]+timeOffset >= 0) cubes[obj.positionY[i]+timeOffset][obj.positionX[i]].element.style.backgroundColor = 'grey';
				}*/
			}
			
			function getTopCenterBlock(){
				var sel = Math.floor(columns/2);				
				return cubes[0][sel];
			}
			
			/*----------Start Grid Making--------------*/
			
			// Find the number of cubes that fit vertically
			function divideWinVertical(wH, cubeSize, padding){
				var cubeV_noSpace = wH / cubeSize;
				rows = (wH - cubeV_noSpace) / cubeSize;
				rows = Math.floor(rows);

				return rows;
			}
			
			// Find the number of cubes that fit horizontally
			function divideWinHorizontal(wW, cubeSize){
				var cubeH_noSpace = wW / cubeSize;
				columns = (wW - (cubeH_noSpace)) / cubeSize;
				columns = Math.floor(columns);
				console.log("horizontal blocks: " + columns);
				return columns;
			}
			
			function CreateGrid(size, numberOfCubesH, numberOfCubesV){
				var i;
				var j;
				for(j = 0; j < numberOfCubesV; j++){
					cubes[j] = new Array();
					for(i = 0; i <  numberOfCubesH ; i++){
						cubes[j][i] = new cube(size, j, i);
						document.getElementById("wrapper").appendChild(cubes[j][i].element);
					}
					
					//Check if number of rows is over and prevent from adding more rows.
					var rect = cubes[j][i-1].element.getBoundingClientRect();
					if(rect.bottom > windowH -20) return;
					
					var br = document.createElement('br');
					document.getElementById("wrapper").appendChild(br);
				}
								
				console.log("Horizontal: "+numberOfCubesH);
				console.log("Vertical: "+numberOfCubesV);
			}
		
		
		$(document).ready(function(){
		
			//var windowH = $(document).height();
			//var windowW = $(document).width();

			
			windowH = document.getElementById('wrapper').clientHeight;
			windowW = document.getElementById('wrapper').clientWidth;

			var cubeSize = 18;
			console.log("document.height: "+windowH);
			console.log("document.width: " +windowW);
			
			var vCubes = divideWinVertical(windowH, cubeSize);
			var hCubes = divideWinHorizontal(windowW, cubeSize);
			CreateGrid(cubeSize, hCubes, vCubes);
			
			console.log("Vertical blocks: " + rows);
			
			//placePiece(newPiece());
			clickTime(newPiece());
		});
		
		
		
		
		</script>
		
	</head>
	<body>
	
	<div id="wrapper"></div>
	
	</body>
</html>